# 38. Servlet 기초



### 01. servlet 생성

1. File > new > servlet

2. Source 폴더를 확인 후, Java package와 Class name 설정 > Finish

3. `@WebServlet("/서블렛호출이름")`

4. `doGet` :arrow_right: `method="get"`

5. `doPost` :arrow_right: `method="post"`


- 예제)

  - getJsp.jsp

    ```jsp
    <%@ page language="java" contentType="text/html; charset=UTF-8"
        pageEncoding="UTF-8"%>
    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    </head>
    <body>
    	<h1>Get방식</h1>
    	<form action="GetServlet" method="get">
    		msg <input name="msg">
    		<input type="submit" value="전송">
    	</form>
    	
    	<h1>Post방식</h1>
    	<form action="PostServlet" method="post">
    		msg <input name="msg">
    		<input type="submit" value="전송">
    	</form>
    </body>
    </html>
    ```

  - GetServlet.java

    ```java
    package ch08;

    import java.io.IOException;
    import java.io.PrintWriter;

    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    /**
     * Servlet implementation class GetServlet
     */
    @WebServlet("/GetServlet")
    public class GetServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public GetServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		String msg = request.getParameter("msg");
    		response.setContentType("text/html; charset=UTF-8");
    		PrintWriter out = response.getWriter(); 
    		out.println("<html>");
    		out.println("<body>");
    		out.println("<h1>Get Servlet 방식</h1>");
    		out.println("<h2>msg : "+msg + "</h2>");
    		out.println("</body>");
    		out.println("</html>");
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// TODO Auto-generated method stub
    		doGet(request, response);
    	}
    }
    ```

  - PostServlet.java

    ```java
    package ch08;

    import java.io.IOException;
    import java.io.PrintWriter;

    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    /**
     * Servlet implementation class GetServlet
     */
    @WebServlet("/PostServlet")
    public class PostServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public PostServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// get으로 받을 때
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// 서버가 클라이언트로부터 받은 요청의 문자 인코딩(msg호출되기 전에)
    		request.setCharacterEncoding("utf-8");
    		
    		String msg = request.getParameter("msg");
    		
    		// HTML 페이지에 한글이 포함된 경우, 클라이언트가 이를 올바르게 보여주기 위한 문자 인코딩
    		response.setContentType("text/html; charset=UTF-8");
    		
    		PrintWriter out = response.getWriter(); 
    		out.println("<html>");
    		
    		// 한글이 깨져서 나온다면 아래의 코드를 추가해도 됨
    		// out.println("<head>");
    		// out.println("<meta charset=\"UTF-8\">");
    		// out.println("<head>");
    		
    		out.println("</head>");
    		out.println("<body>");
    		out.println("<h1>Post Servlet 방식</h1>");
    		out.println("<h2>msg : "+msg + "</h2>");
    		out.println("</body>");
    		out.println("</html>");
    	}
    }
    ```

    ​

### 02. Beans

- 자바빈즈 작성
  1. 정보를 저장하는 변수는 모두 `private`로 선언
  2. `private`로 선언된 변수의 값을 저장하는 메소드생성 (`getter`)
     - 메소드 이름 `setXxx()` 형식
     - `Xxx`는 변수의 이름과 같으며 첫 글자는 대문자
  3. `private`로 선언된 변수의 값을 가져오는 메소드 생성 (`setter`)
     - 메소드 이름 `getXxx()` 형식
     - `Xxx`는 변수의 이름과 같으며 첫 글자는 대문자
  4. `setXxx()` 메소드와 `getXxx()` 메소드를 `public`으로 선언
     - 간접 접근 허용
     - 직접 접근 X



### 03. 데이터베이스

- [MySQL download](https://downloads.mysql.com/archives/community/) 
  - Ver. 5.5.62 (zip이 아닌 **installer 버전을 권장**)
  - zip파일은 설정할 게 많음
  - rc는 Release Candidate의 약자로 출시 후보 버전 또는 프리뷰 릴리즈 버전을 의미하므로 공식 버전이 X (주의)

> 1. 기본 (defualt) 설정으로 진행
> 2. Multiple 선택
>    - transaction 이 없는 버전은 속도는 빠르지만 자동 트랜잭션으로 위험성 있음
> 3. Port Number은 다른 DBMS 사용시, 겹치지 않도록 조심
>    - MariaDB도 MySQL와 똑같이 기본 포트 번호가 3306
> 4. Manual Selected Default Character Set :arrow_right: `utf-8`
> 5. Modify Security Settings :arrow_right: 비밀번호 설정
>    - 다른 OS나 환경에서 실행할 경우 `Enable root from remote machine` 원격 접속 허용을 체크해야 하지만, 요즘에는 보안을 위해 허용하지 않음
> 6. finish



- [워크벤치 다운로드](https://dev.mysql.com/downloads/file/?id=536668)
  - No thanks, just start my download 를 클릭하면 무료 다운로드 가능
  - 설치 후, root 접속 및 설정 비밀번호 입력

```sql
create database mydb default charset utf8 collate utf8_general_ci;

/*
사용자 생성 
@localhost는 로컬에서만 접속가능
identified by : 비밀번호
*/
create user 'hkd'@'localhost' identified by '1234';

/*
 * 는 모든 테이블 권한
*/
grant all privileges on mydb.* to 'hkd'@'localhost';
flush privileges;
```



- `hkd`으로 workbench 추가(`My connection +`)

  - Connection Name 자유
  - Username: `hkd`
  - Test Connection > 비밀번호 입력 > OK

  ```sql
  use mydb; -- db선택 alter

  /*
  Oracle과 다르게 varchar2가 없고 int를 사용
  */
  create table tblRegister(
  	id varchar(20) primary key,
      pwd varchar(20) not null,
      name varchar(20) not null,
      email varchar(30) not null,
      phone varchar(30) not null
  );

  insert into tblRegister values('hkd','1234','홍길동','hkd@email.com','010-1234-1234');
  -- commit 필요없이 자동commit
  select * from tblRegister;

  update tblRegister set pwd='1111' where id='hkd';
  delete from tblRegister where id='hkd';
  -- delete from tblRegister; 프라이머리 키가 safe updates 로 인해 삭제 방지
  -- 설정>SQL Editer 가장 하단에 체크박스 

  -- 수동 트랜잭션시작
  start transaction; -- 트랜잭션 시작 commit, rollback 가능

  insert into tblRegister values('hkd','1234','홍길동','hkd@email.com','010-1234-1234');
  commit;

  delete from tblRegister where id='hkd';
  select * from tblRegister;
  rollback;
  ```



### 04. JDBC

- [MySQL Connet J download](https://downloads.mysql.com/archives/c-j/)

  - ver 5.1.45 `zip` 파일 다운로드

  - 프로젝트 src/main/webapp/WEB-INF/lib 에 `.jar` 붙여넣기

  - dbcpTest.jsp

    ```java
    <%@page import="java.sql.SQLException"%>
    <%@page import="java.sql.Connection"%>
    <%@page import="java.sql.DriverManager"%>
    <%@ page language="java" contentType="text/html; charset=UTF-8"
        pageEncoding="UTF-8"%>
    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    </head>
    <body>
    <%
    	Connection con;
    	
    	try{
    		Class.forName("org.gjt.mm.mysql.Driver").newInstance();
    		con=DriverManager.getConnection("jdbc:mysql://localhost:3306/mydb", "root", "1234");
    		System.out.println("Success");
    	}
    	catch(SQLException ex){ System.out.println("SQLException" + ex);}
    	catch(Exception ex){ System.out.println("Exception:" + ex);}
    %>
    </body>
    </html>
    ```

  - Database Connection Pooling (DBCP)




### 05. ConnectionPool

- 데이터베이스에 연결하고 질의와 결과를 받아오는 부분에서 많은시간 소요
  - 해당 과정에서 서버에 많은 부하(memory)를 줌 (+동시 접속자)

  - ConnetcionPool을 사용하여 부하를 줄여줌

  - Database Connection Pooling (DBCP)

    - 동시접속자가 많을 때 각 사용자 마다 Connection 객체를 매번 새로 생성해서 종료하는 방법을 개선해서, Connection 객체를 미리 Connection Pool에 여러개 만들어 두고, 연결이 필요할 때 빌려쓰고 필요없을 때 반납하는 개념
    - 초기에는 WAS와 별도로 설치해서 사용
    - Tomcat 자체에 DBCP기능이 추가됨

    \* Spring에서는 Hikari DBCP를 추천



**Pooling 기법**

- 효율적으로 복수의 사용자에게 서비스하기위해 미리 데이터베이스 연결을 위한 객체들을 생성
- Connection 객체의 **재사용**(Connection 객체를 미리 생성 빌려주고 반납하는 개념)
  - 데이터베이스 연결 객체를 매번 생성, 사용, 해제 하지않고 처음 만들어둔 데이터베이스 연결 객체를 계속 사용
- 사용자에게 필요한 응답을 주는데 걸리는 시간을 단축하고 시스템 부하를 줄임




> **DBCP Aphach Tomcat**
>
> [Tomcat Documentation 설정](https://tomcat.apache.org/tomcat-9.0-doc/jndi-datasource-examples-howto.html)
>
> 아래는 mysql 기준
>
> - 전역(global)적으로 설정
>
>   - Server/context.xml/Context태그 내부에 삽입
>
>   ```xml
>   <Resource name="jdbc/TestDB" auth="Container" type="javax.sql.DataSource"
>             maxTotal="100" maxIdle="30" maxWaitMillis="10000"
>             username="hkd" password="1234" driverClassName="com.mysql.jdbc.Driver"
>             url="jdbc:mysql://localhost:3306/mydb"/>
>   ```
>
>   - web.xml/web-app 태그 내부에 삽입
>
>   ```xml
>   <resource-ref>
>       <description>DB Connection</description>
>       <res-ref-name>jdbc/TestDB</res-ref-name>
>       <res-type>javax.sql.DataSource</res-type>
>       <res-auth>Container</res-auth>
>   </resource-ref>
>   ```
>
>   - connectionPool.jsp를 앱안에 생성한 후 
>
>   ```jsp
>   <%@page import="javax.naming.InitialContext"%>
>   <%@page import="javax.sql.DataSource"%>
>   <%@page import="javax.naming.Context"%>
>   <%@page import="java.sql.SQLException"%>
>   <%@page import="java.sql.Connection"%>
>   <%@page import="java.sql.DriverManager"%>
>   <%@ page language="java" contentType="text/html; charset=UTF-8"
>       pageEncoding="UTF-8"%>
>   <!DOCTYPE html>
>   <html>
>   <head>
>   <meta charset="UTF-8">
>   <title>Insert title here</title>
>   </head>
>   <body>
>   <%
>   	Context initContext = new InitialContext();
>   	Context envContext  = (Context)initContext.lookup("java:/comp/env");
>   	DataSource ds = (DataSource)envContext.lookup("jdbc/TestDB");
>   	Connection conn = ds.getConnection();
>   	System.out.println("연결됨");
>   %>
>   </body>
>   </html>
>   ```
>
>   ​



> **Oracle 연동**
>
> - context.xml
>
>   ```xml
>   <!-- <Resource name="jdbc/TestDB" auth="Container" type="javax.sql.DataSource"
>                  maxTotal="100" maxIdle="30" maxWaitMillis="10000"
>                  username="hkd" password="1234" driverClassName="com.mysql.jdbc.Driver"
>                  url="jdbc:mysql://localhost:3306/mydb"/> -->
>   <Resource name="jdbc/myoracle" auth="Container"
>                 type="javax.sql.DataSource" driverClassName="oracle.jdbc.OracleDriver"
>                 url="jdbc:oracle:thin:@127.0.0.1:1521:mysid"
>                 username="유저이름" password="비밀번호" maxTotal="20" maxIdle="10"
>                 maxWaitMillis="-1"/>
>   ```
>
>   - mysql과 이름이 다르기 때문에 충돌나지 X
>   - mysid > sid 
>     - 모르면 Oracle 접속해서 유저 우클릭 속성 들어가서 확인하면 됨
>
> - web.xml
>
>   ```xml
>   		...
>   		<!-- <resource-ref>
>   	    <description>DB Connection</description>
>   	    <res-ref-name>jdbc/TestDB</res-ref-name>
>   	    <res-type>javax.sql.DataSource</res-type>
>   	    <res-auth>Container</res-auth>
>   	</resource-ref> -->
>   	
>   	<resource-ref>
>   		 <description>Oracle Datasource example</description>
>   		 <res-ref-name>jdbc/myoracle</res-ref-name>
>   		 <res-type>javax.sql.DataSource</res-type>
>   		 <res-auth>Container</res-auth>
>   	</resource-ref>
>   </web-app>
>   ```
>
>   - 오류는 나지 않지만 mysql 주석처리
>
> - webapp(webContent)/dbcp.jsp
>
>   ```jsp
>   <%@page import="java.sql.Connection"%>
>   <%@page import="javax.sql.DataSource"%>
>   <%@page import="javax.naming.InitialContext"%>
>   <%@page import="javax.naming.Context"%>
>   <%@ page language="java" contentType="text/html; charset=UTF-8"
>       pageEncoding="UTF-8"%>
>   <!DOCTYPE html>
>   <html>
>   <head>
>   <meta charset="UTF-8">
>   <title>Insert title here</title>
>   </head>
>   <body>
>   <%
>   	Context initContext = new InitialContext();
>   	Context envContext  = (Context)initContext.lookup("java:/comp/env");
>   	DataSource ds = (DataSource)envContext.lookup("jdbc/myoracle");
>   	Connection conn = ds.getConnection();
>   	
>   	System.out.println("연결됨");
>   %>
>   </body>
>   </html>
>   ```
>
>   - ojdbc 라이브러리가 없으면 실행이 안되므로 라이브러리 확인
>
> 1. 드라이버가 없거나(설정이 안되었거나)
> 2. DB의 유저나 비밀번호가 맞지 않거나
> 3. sid설정이 잘못 되었거나 



### 06. JSP Model2

- MVC 패턴

  > Model(데이터) - Bean
  >
  > View(UI) - JSP `<%%>`를 최대한 사용하지 않음. action tag, JSTL 주로 사용
  >
  > Controller(로직) - Servlet

  - MVC 패턴 코딩시 주요사항

    1. 주소는 Servlet주소(가상주소) 사용

       - 예) `~/list.jsp` (X) `~/list.do` (O)
       - Controller를 통해 View에 접근해야 하기 때문
       - index.jsp는 예외

    2. Model을 활용

       - 폼에 입력된 데이터는 Model에 저장해야 함

         DTO(Data Transfer Object)
         VO(Value Object) - read on(읽기 전용)
         최근 경향은 DTO를 더 많이 사용

       - query를 실행할 때도 Model을 사용
         `insert`, `updqte`할 때 Model에 넣어서 사용
         `select`한 결과를 Model에 넣어서 view로 전달



### 07. 프로젝트 시작

- Member 다이나믹 프로젝트 생성 후 위와 같이 setting

- Oracle에서 MEMBER 테이블 생성 후 임시 데이터 생성

  ```sql
  create table member(
      name varchar2(20) not null,
      userid varchar2(20) primary key,
      pwd varchar2(20) not null,
      email varchar2(50) not null,
      phone varchar2(20) not null,
      admin number default 1 -- 관리자/일반회원
  );
  insert into member values('홍길동','hkd','1234','hkd@email.com','010-1234-5678',1); 
  select * from member;
  commit;
  ```

- Beans 생성

  - MemberVO.java

    ```java
    package com.saeyon.dto;

    public class MemberVO {
    	private String name;
    	private String userid;
    	private String pwd;
    	private String email;
    	private String phone;
    	private int admin;
    	public String getName() {
    		return name;
    	}
    	public void setName(String name) {
    		this.name = name;
    	}
    	public String getUserid() {
    		return userid;
    	}
    	public void setUserid(String userid) {
    		this.userid = userid;
    	}
    	public String getPwd() {
    		return pwd;
    	}
    	public void setPwd(String pwd) {
    		this.pwd = pwd;
    	}
    	public String getEmail() {
    		return email;
    	}
    	public void setEmail(String email) {
    		this.email = email;
    	}
    	public String getPhone() {
    		return phone;
    	}
    	public void setPhone(String phone) {
    		this.phone = phone;
    	}
    	public int getAdmin() {
    		return admin;
    	}
    	public void setAdmin(int admin) {
    		this.admin = admin;
    	}
    }
    ```

    - 변수만 생성 후 클래스 블록 안에서, 
      Source탭 > **Generate getters and setters** 를 이용하면 편리하게 getter, setter를 만들 수 있음

  - MemberDAO.java

    ```java
    package com.saeyon.dao;

    import java.sql.Connection;
    import java.sql.PreparedStatement;
    import java.sql.ResultSet;

    import javax.naming.Context;
    import javax.naming.InitialContext;
    import javax.sql.DataSource;

    import com.saeyon.dto.MemberVO;

    public class MemberDAO {
    	// singleton pattern
    	// => 생성자를 private로 설정. 직접 instance를 private static으로 생성해서 공유(메모리 절약)
    	
    	// private 생성자
    	private MemberDAO() {}
    	
    	// instance 생성
    	private static MemberDAO instance=new MemberDAO();
    	
    	// instance 리턴
    	public static MemberDAO getInstance() {
    		return instance;
    	}
    	
    	// DBCP연결 connection 객체 생성
    	public Connection getConnection() throws Exception{
    		Connection conn = null;
    		Context initContext = new InitialContext();
    		Context envContext = (Context) initContext.lookup("java:/comp/env");
    		DataSource ds = (DataSource) envContext.lookup("jdbc/myoracle");
    		conn = ds.getConnection();
    		return conn;
    	}
    	
    	// 로그인시 사용하는 메서드
    	public int userCheck(String userid, String pwd) {
    		int result=-1; // 기본값
    		
    		String sql="select pwd from member where userid=?";
    		Connection conn=null;
    		PreparedStatement pstmt=null;
    		ResultSet rs=null;
    		
    		try {
    			conn=getConnection(); // connection 객체 생성
    			pstmt=conn.prepareStatement(sql); // prepareStatment 객체 생성
    			pstmt.setString(1, userid); // query문의 ? 위치에 들어가는 값 세팅
    			rs=pstmt.executeQuery();
    			if(rs.next()) {
    				if(rs.getString("pwd")!=null && rs.getString("pwd").equals(pwd)) {
    					result=1; // 비밀번호 일치
    				}else {
    					result=0; // 비밀번호 불일치
    				}
    			}else {
    				result=-1; // id가 없음
    			}
    		}catch(Exception e) {
    			e.printStackTrace();
    		}finally {
    			try {
    				if (rs != null)
    					rs.close();
    				if (pstmt != null)
    					pstmt.close();
    				if (conn != null)
    					conn.close();
    			} catch (Exception e) {
    				e.printStackTrace();
    			}
    		}
    		return result;
    	}
    	
    	// id중복체크
    	public int confirmID(String userid) {
    		int result = -1;
    		String sql = "select userid from member where userid=?";
    		Connection conn = null;
    		PreparedStatement pstmt = null;
    		ResultSet rs = null;
    		try {
    			conn = getConnection();
    			pstmt = conn.prepareStatement(sql);
    			pstmt.setString(1, userid);
    			rs = pstmt.executeQuery();
    			if (rs.next()) {
    				result = 1; // id가 중복됨
    			} else {
    				result = -1; // id가 중복안됨
    			}
    		} catch (Exception e) {
    			e.printStackTrace();
    		} finally {
    			try {
    				if (rs != null)
    					rs.close();
    				if (pstmt != null)
    					pstmt.close();
    				if (conn != null)
    					conn.close();
    			} catch (Exception e) {
    				e.printStackTrace();
    			}
    		}
    		return result;
    	}
    	
    	// 회원등록
    	public int insertMember(MemberVO mVo) {
    		int result = -1;
    		String sql = "insert into member values(?, ?, ?, ?, ?, ?)";
    		Connection conn = null;
    		PreparedStatement pstmt = null;
    		try {
    			conn = getConnection();
    			pstmt = conn.prepareStatement(sql);
    			pstmt.setString(1, mVo.getName());
    			pstmt.setString(2, mVo.getUserid());
    			pstmt.setString(3, mVo.getPwd());
    			pstmt.setString(4, mVo.getEmail());
    			pstmt.setString(5, mVo.getPhone());
    			pstmt.setInt(6, mVo.getAdmin());
    			result = pstmt.executeUpdate();// 영향을 받은 행의 수 리턴. insert하면 1행이 추가되므로 1이 리턴됨.
    		} catch (Exception e) {
    			e.printStackTrace();
    		} finally {
    			try {
    				if (pstmt != null)
    					pstmt.close();
    				if (conn != null)
    					conn.close();
    			} catch (Exception e) {
    				e.printStackTrace();
    			}
    		}
    		return result;
    	}

    	// 회원정보검색
    	public MemberVO getMember(String userid) {
    		MemberVO mVo=null;
    		String sql="select * from member where userid=?";
    		Connection conn=null;
    		PreparedStatement pstmt=null;
    		ResultSet rs=null;
    		try {
    			conn=getConnection();
    			pstmt=conn.prepareStatement(sql);
    			pstmt.setString(1,  userid);
    			rs=pstmt.executeQuery();
    			if(rs.next()) {
    				// Model 객체에 입력한 값을 저장
    				mVo=new MemberVO();
    				mVo.setName(rs.getString("name"));
    				mVo.setUserid(rs.getString("userid"));
    				mVo.setPwd(rs.getString("pwd"));
    				mVo.setEmail(rs.getString("email"));
    				mVo.setPhone(rs.getString("phone"));
    				mVo.setAdmin(rs.getInt("admin"));
    			}
    		}catch(Exception e) {
    			e.printStackTrace();
    		}finally {
    			try {
    				if(rs!=null) rs.close();
    				if(pstmt!=null) rs.close();
    				if(conn!=null) rs.close();
    			}catch(Exception e) {e.printStackTrace();}
    		}
    		return mVo;
    	}

    	// 회원정보 수정
    	public int updateMember(MemberVO mVo) {
    		int result = -1;
    		String sql = "update member set pwd=?, email=?,"
    				+ "phone=?, admin=? where userid=?";
    		Connection conn = null;
    		PreparedStatement pstmt = null;
    		try {
    			conn = getConnection();
    			pstmt = conn.prepareStatement(sql);
    			pstmt.setString(1, mVo.getPwd());
    			pstmt.setString(2, mVo.getEmail());
    			pstmt.setString(3, mVo.getPhone());
    			pstmt.setInt(4, mVo.getAdmin());
    			pstmt.setString(5, mVo.getUserid());
    			result = pstmt.executeUpdate();//영향을 받은 행의 수 리턴. 영향을 받은행의수는 1.
    		} catch (Exception e) {
    			e.printStackTrace();
    		} finally {
    			try {
    				if (pstmt != null)
    					pstmt.close();
    				if (conn != null)
    					conn.close();
    			} catch (Exception e) {
    				e.printStackTrace();
    			}
    		}
    		return result;
    	}
    }
    ```

  - LoginServlet.java (new servlet) package : com.saeyon.controller

    - 앞으로 서블릿은 여기에 저장

    ```java
    package com.saeyon.controller;

    import java.io.IOException;

    import javax.servlet.RequestDispatcher;
    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import javax.servlet.http.HttpSession;

    import com.saeyon.dao.MemberDAO;

    /**
     * Servlet implementation class LoginServlet
     */
    @WebServlet("/login.do")
    public class LoginServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public LoginServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		String url="member/login.jsp";
    		HttpSession session = request.getSession(); // session객체 구하기
    		if (session.getAttribute("loginUser") != null) {// 이미 로그인 된 사용자이면
    			url = "main.jsp"; // 메인 페이지로 이동한다.
    		}
    		RequestDispatcher dispatcher = request.getRequestDispatcher(url);
    		dispatcher.forward(request, response); // 주소가 변경되지 않음 (주소를 바꾸소 싶을 경우 redirect)
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		String url="member/login.jsp";
    		String userid=request.getParameter("userid");
    		String pwd=request.getParameter("pwd");
    		MemberDAO mDao=MemberDAO.getInstance();
    		int result = mDao.userCheck(userid, pwd);
    		if(result==1) { // id,비밀번호가 일치할때
    			HttpSession session=request.getSession();
    			session.setAttribute("loginUser", userid);
    			url="main.do";
    			
    			response.sendRedirect(url); // 주소변경
    		}else if(result==0) { // 비밀번호가 일치하지 않을 때
    			request.setAttribute("message", "비밀번호가 맞지 않습니다.");
    			RequestDispatcher dispatcher = request.getRequestDispatcher(url);
    			dispatcher.forward(request, response); // 주소가 변경되지 않음 (주소를 바꾸소 싶을 경우 redirect)
    		}else if(result==-1) { // 아이디가 존재하지 않을 때
    			request.setAttribute("message", "존재하지않는 아이디");			
    			RequestDispatcher dispatcher = request.getRequestDispatcher(url);
    			dispatcher.forward(request, response); // 주소가 변경되지 않음 (주소를 바꾸소 싶을 경우 redirect)
    		}
    	}

    }

    ```

    - 여기서, login.jsp는 webapp에 member 폴더를 생성한 후 내부에 삽입

      ```jsp
      <%@ page language="java" contentType="text/html; charset=UTF-8"
          pageEncoding="UTF-8"%>
      <!DOCTYPE html>
      <html>
      <head>
      <meta charset="UTF-8">
      <title>로그인</title>
      </head>
      <body>
      	<h2>로그인</h2>
      	<form action="login.do" method="post">
      		<table>
      			<tr>
      				<td>아이디</td>
      				<td><input type="text" name="userid" value="${userid}"></td>
      			</tr>
      			<tr>
      				<td>비밀번호</td>
      				<td><input type="password" name="pwd" ></td>
      			</tr>
      			<tr>
      				<td colspan="2">
      					<input type="submit" value="로그인">
      					<input type=button value="회원가입" onclick="location.href='join.do'">
      				</td>
      			</tr>
      		</table>
      	</form>
      </body>
      </html>
      ```

    - index.jsp 는  app폴더 root에 (webapp 최상위)

      ```jsp
      <%@ page language="java" contentType="text/html; charset=UTF-8"
          pageEncoding="UTF-8"%>
      <!DOCTYPE html>
      <html>
      <head>
      <meta charset="UTF-8">
      <title>로그인</title>
      </head>
      <body>
      	<h2>로그인</h2>
      	<form action="login.do" method="post">
      		<table>
      			<tr>
      				<td>아이디</td>
      				<td><input type="text" name="userid" value="${userid}"></td>
      			</tr>
      			<tr>
      				<td>비밀번호</td>
      				<td><input type="password" name="pwd" ></td>
      			</tr>
      			<tr>
      				<td colspan="2">
      					<input type="submit" value="로그인">
      					<input type=button value="회원가입" onclick="location.href='join.do'">
      				</td>
      			</tr>
      			<tr>
      				<td colspan="2">${message}</td>
      			</tr>
      		</table>
      	</form>
      </body>
      </html>
      ```

      - 앞에 원치않는 path가 붙었을 때

        하단의 Server를 클릭해서 서버 더블클릭 후, Module에서 기본 path를 설정할 수 있음

  - 유저 검증 성공, 또는 실패시 보낼 요청을 가려받기 위해 main.jsp

    ```jsp
    <%@ page language="java" contentType="text/html; charset=UTF-8"
        pageEncoding="UTF-8"%>
    <!DOCTYPE html>
    <html>
    <head>
    <meta charset="UTF-8">
    <title>Insert title here</title>
    </head>
    <body>
    	<h2>회원전용페이지</h2>
    	<form action="logout.do">
    		<table>
    			<tr>
    				<td>안녕하세요. ${loginUser.name}(${loginUser.userid})님</td>
    			</tr>
    			<tr>
    				<td>
    					<input type="submit" value="로그아웃">
    					<input type="button" value="회원정보변경" onclick="location.href='memberUpdate.do?userid=${loginUser.userid}'">
    				</td>
    			</tr>
    		</table>
    	</form>
    </body>
    </html>
    ```

  - MainServlet.java

    ```java
    package com.saeyon.controller;

    import java.io.IOException;

    import javax.servlet.RequestDispatcher;
    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    /**
     * Servlet implementation class MainServlet
     */
    @WebServlet("/main.do")
    public class MainServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public MainServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		RequestDispatcher dispatcher = request.getRequestDispatcher("main.jsp");
    		dispatcher.forward(request, response);//주소가 변경되지 않음.
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// TODO Auto-generated method stub
    		doGet(request, response);
    	}
    }
    ```

    ​

- webapp 폴더에 script 폴더 생성

  - member.js

    ```javascript
    function loginCheck() {
    	if (document.frm.userid.value.length == 0) {
    		alert("아이디를 써주세요");
    		frm.userid.focus();
    		return false;
    	}
    	if (document.frm.pwd.value == "") {
    		alert("암호는 반드시 입력해야 합니다.");
    		frm.pwd.focus();
    		return false;
    	}
    	return true;
    }

    function idCheck() {
    	if (document.frm.userid.value == "") {
    		alert('아이디를 입력하여 주십시오.');
    		document.formm.userid.focus();
    		return;
    	}
    	var url = "idCheck.do?userid=" + document.frm.userid.value;
    	window.open(url, "_blank_1",
    					"toolbar=no, menubar=no, scrollbars=yes, resizable=no, width=450, height=200");
    }

    function idok(userid) {
    	opener.frm.userid.value = document.frm.userid.value;
    	opener.frm.reid.value = document.frm.userid.value;
    	self.close();
    }

    function joinCheck() {
    	if (document.frm.name.value.length == 0) {
    		alert("이름을 써주세요.");
    		frm.name.focus();
    		return false;
    	}
    	if (document.frm.userid.value.length == 0) {
    		alert("아이디를 써주세요");
    		frm.userid.focus();
    		return false;
    	}
    	if (document.frm.userid.value.length < 3) {
    		alert("아이디는 3글자이상이어야 합니다.");
    		frm.userid.focus();
    		return false;
    	}
    	if (document.frm.pwd.value == "") {
    		alert("암호는 반드시 입력해야 합니다.");
    		frm.pwd.focus();
    		return false;
    	}
    	if (document.frm.pwd.value != document.frm.pwd_check.value) {
    		alert("암호가 일치하지 않습니다.");
    		frm.pwd.focus();
    		return false;
    	}
    	if (document.frm.reid.value!=document.frm.userid.value) {
    		alert("중복 체크를 하지 않았습니다.");
    		frm.userid.focus();
    		return false;
    	}
    	return true;
    }
    ```

    - 유효성 체크

  - IdCheckServlet.java

    ```java
    package com.saeyon.controller;

    import java.io.IOException;

    import javax.servlet.RequestDispatcher;
    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    import com.saeyon.dao.MemberDAO;

    /**
     * Servlet implementation class IdCheckServlet
     */
    @WebServlet("/idCheck.do")
    public class IdCheckServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public IdCheckServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		String userid = request.getParameter("userid");
    		MemberDAO mDao = MemberDAO.getInstance();
    		int result = mDao.confirmID(userid);
    		request.setAttribute("userid", userid);
    		request.setAttribute("result", result);
    		RequestDispatcher dispatcher = request.getRequestDispatcher("member/idcheck.jsp");
    		dispatcher.forward(request, response);
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// TODO Auto-generated method stub
    		doGet(request, response);
    	}
    }
    ```

  - JoinServlet.java

    ```JAVA
    package com.saeyon.controller;

    import java.io.IOException;

    import javax.servlet.RequestDispatcher;
    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import javax.servlet.http.HttpSession;

    import com.saeyon.dao.MemberDAO;
    import com.saeyon.dto.MemberVO;

    /**
     * Servlet implementation class JoinServlet
     */
    @WebServlet("/join.do")
    public class JoinServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public JoinServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		RequestDispatcher dispatcher = request.getRequestDispatcher("member/join.jsp");
    		dispatcher.forward(request, response);
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		request.setCharacterEncoding("UTF-8");
    		String name = request.getParameter("name");
    		String userid = request.getParameter("userid");
    		String pwd = request.getParameter("pwd");
    		String email = request.getParameter("email");
    		String phone = request.getParameter("phone");
    		String admin = request.getParameter("admin");
    		MemberVO mVo = new MemberVO();
    		mVo.setName(name);
    		mVo.setUserid(userid);
    		mVo.setPwd(pwd);
    		mVo.setEmail(email);
    		mVo.setPhone(phone);
    		mVo.setAdmin(Integer.parseInt(admin));
    		MemberDAO mDao = MemberDAO.getInstance();
    		int result = mDao.insertMember(mVo);
    		HttpSession session = request.getSession();
    		if (result == 1) {
    			session.setAttribute("userid", mVo.getUserid());
    			request.setAttribute("message", "회원 가입에 성공했습니다.");
    		} else {
    			request.setAttribute("message", "회원 가입에 실패했습니다.");
    		}
    		RequestDispatcher dispatcher = request
    				.getRequestDispatcher("member/login.jsp");
    		dispatcher.forward(request, response);
    	}
    }
    ```

    ​

> **마무리**
>
> - 라이브러리에 jstl추가
>
> - member폴더에 추가
>
>   - idcheck.jsp
>
>     ```jsp
>     <%@ page language="java" contentType="text/html; charset=UTF-8"
>     	pageEncoding="UTF-8"%>
>     <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c"%>
>     <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
>     <html>
>     <head>
>     <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
>     <title>Insert title here</title>
>     <script type="text/javascript" src="script/member.js"></script>
>     </head>
>     <body>
>     	<h2>아이디 중복확인</h2>
>     	<form action="idCheck.do" method="get" name="frm">
>     		아이디 <input type=text name="userid" value="${userid}"> <input type=submit
>     			value="중복 체크"> <br>
>     		<c:if test="${result == 1}">
>     			<script type="text/javascript">
>     				opener.document.frm.userid.value = "";
>     			</script>
>     			${userid}는 이미 사용 중인 아이디입니다.
>     		</c:if>
>     		<c:if test="${result==-1}">
>     		${userid}는 사용 가능한 아이디입니다.
>     		<input type="button" value="사용" class="cancel" onclick="idok('${userid}')">
>     		</c:if>
>     	</form>
>     </body>
>     </html>
>     ```
>
>   - join.jsp
>
>     ```java
>     <%@ page language="java" contentType="text/html; charset=UTF-8"
>     	pageEncoding="UTF-8"%>
>     <!DOCTYPE html>
>     <html>
>     <head>
>     <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
>     <title>Insert title here</title>
>     <script type="text/javascript" src="script/member.js"></script>
>     </head>
>     <body>
>     	<h2>회원 가입</h2>
>     	'*' 표시 항목은 필수 입력 항목입니다.
>     	<form action="join.do" method="post" name="frm">
>     		<table>
>     			<tr>
>     				<td>이름</td>
>     				<td><input type="text" name="name" size="20">*</td>
>     			</tr>
>     			<tr>
>     				<td>아이디</td>
>     				<td><input type="text" name="userid" size="20"  id="userid">* <input
>     					type="hidden" name="reid" size="20"> <input type="button"
>     					value="중복 체크" onclick="idCheck()"></td>
>     			</tr>
>     			<tr>
>     				<td>암 호</td>
>     				<td><input type="password" name="pwd" size="20">*</td>
>     			</tr>
>     			<tr height="30">
>     				<td width="80">암호 확인</td>
>     				<td><input type="password" name="pwd_check" size="20">*</td>
>     			</tr>
>     			<tr>
>     				<td>이메일</td>
>     				<td><input type="text" name="email" size="20"></td>
>     			</tr>
>     			<tr>
>     				<td>전화번호</td>
>     				<td><input type="text" name="phone" size="20"></td>
>     			</tr>
>     			<tr>
>     				<td>등급</td>
>     				<td><input type="radio" name="admin" value="0"
>     					checked="checked"> 일반회원 <input type="radio" name="admin"
>     					value="1"> 관리자</td>
>     			</tr>
>     			<tr>
>     				<td colspan="2" align="center"><input type="submit" value="확인"
>     					onclick="return joinCheck()">
>     					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <input type="reset" value="취소">
>     				</td>
>     			</tr>
>     			<tr>
>     				<td colspan="2">${message }</td>
>     			</tr>
>     		</table>
>     	</form>
>     </body>
>     </html>
>     ```
>
>     ​

- MemberUpdateServlet.java

  ```java
  package com.saeyon.controller;

  import java.io.IOException;

  import javax.servlet.RequestDispatcher;
  import javax.servlet.ServletException;
  import javax.servlet.annotation.WebServlet;
  import javax.servlet.http.HttpServlet;
  import javax.servlet.http.HttpServletRequest;
  import javax.servlet.http.HttpServletResponse;

  import com.saeyon.dao.MemberDAO;
  import com.saeyon.dto.MemberVO;

  /**
   * Servlet implementation class MemberUdate
   */
  @WebServlet("/memberUpdate.do")
  public class MemberUpdateServlet extends HttpServlet {
  	private static final long serialVersionUID = 1L;
         
      /**
       * @see HttpServlet#HttpServlet()
       */
      public MemberUpdateServlet() {
          super();
          // TODO Auto-generated constructor stub
      }

  	/**
  	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
  	 */
  	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
  		String userid = request.getParameter("userid");
  		MemberDAO mDao = MemberDAO.getInstance();
  		MemberVO mVo = mDao.getMember(userid);
  		request.setAttribute("mVo", mVo); // view로 mVo전달
  		RequestDispatcher dispatcher = request.getRequestDispatcher("member/memberUpdate.jsp");
  		dispatcher.forward(request, response);	}

  	/**
  	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
  	 */
  	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
  		request.setCharacterEncoding("UTF-8"); // 한글 깨짐을 방지
  		// 폼에서 입력한 회원 정보 얻어오기
  		String userid = request.getParameter("userid");
  		String pwd = request.getParameter("pwd");
  		String email = request.getParameter("email");
  		String phone = request.getParameter("phone");
  		String admin = request.getParameter("admin");
  		// 회원 정보를 저장할 객체 생성
  		MemberVO mVo = new MemberVO();
  		mVo.setUserid(userid);
  		mVo.setPwd(pwd);
  		mVo.setEmail(email);
  		mVo.setPhone(phone);
  		mVo.setAdmin(Integer.parseInt(admin));
  		MemberDAO mDao = MemberDAO.getInstance();
  		mDao.updateMember(mVo);
  		response.sendRedirect("login.do");
  	}

  }
  ```

  - LogoutServlet.java

    ```java
    package com.saeyon.controller;

    import java.io.IOException;

    import javax.servlet.RequestDispatcher;
    import javax.servlet.ServletException;
    import javax.servlet.annotation.WebServlet;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;
    import javax.servlet.http.HttpSession;

    /**
     * Servlet implementation class LogoutServlet
     */
    @WebServlet("/logout.do")
    public class LogoutServlet extends HttpServlet {
    	private static final long serialVersionUID = 1L;
           
        /**
         * @see HttpServlet#HttpServlet()
         */
        public LogoutServlet() {
            super();
            // TODO Auto-generated constructor stub
        }

    	/**
    	 * @see HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doGet(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		HttpSession session=request.getSession();
    		session.invalidate(); // session비활성 모든 session attribute 삭제됨
    //		RequestDispatcher dispatcher=requestDispatcher.("member/login.jsp"); //로그인 페이지로 이동
    //		dispatcher.forward(request.response);
    		response.sendRedirect("login.do");
    		
    	}

    	/**
    	 * @see HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)
    	 */
    	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
    		// TODO Auto-generated method stub
    		doGet(request, response);
    	}
    }
    ```

    ​

### 08. 작업 순서

> 1. Database Table 생성
> 2. VO, VAD(CRUD) - Model
>    - 요즘은 VO보다는 DTO라고 함
> 3. Controller에서 VO와 전달 응답
> 4. View (`~.jsp`)는 Controller에서 VO를 전달 받음

- Tomcat이 수정사항을 바로 적용하지 못할 시, 세션, 쿠키, (서버 우클릭)clear 등을 사용