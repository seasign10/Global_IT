# 41. Spring Basic

- **STS**(Spring Tool Suite)
  - 이클립스를 베이스로 만든 spring용 ide
  - [STS3](https://download.springsource.com/release/STS/3.9.18.RELEASE/dist/e4.21/spring-tool-suite-3.9.18.RELEASE-e4.21.0-win32-x86_64.zip) 이후 ([download site](https://github.com/spring-attic/toolsuite-distribution/wiki/Spring-Tool-Suite-3))
    - STS4 - StringBoot 용
    - ST(Spring Tools)로 변경됨
    - VSCode용 ST 공식발표

> **전자정부 프레임워크**
>
> 스프링 기반으로 만든 대한민국 정부기관(공공) 프로젝트에서 사용하는 표준 프레임워크. `4.0`이후 spring boot 정식 지원



- File > New > Spring Legacy Project(없으면 Other에서)
  - mvc templates을 추가하기위해 첨부파일[org.springframework.templates.mvc-3.2.2]을 다운로드
  - `...workspace\spring_workspace\.metadata\.sts\content` 경로에 그대로 압축 풀기
  - Spring Legacy Project > Configure templates 에서 Templates Project에 있는 3줄(자동 추가된 것)을 삭제후 Apply 하면 `Spring MVC Project`가 추가됨
    - 여기서 JDK 버전이 여러개면 인식이 충돌날 수 있음
      - **Windows > Preferences** 
        - **Java** > installed JREs - JDK 11 
        - **Java** > Compiler > Compiler compliance level : 11
        - **Web** > JSP Files > Encoding : UTF-8로 변경
        - **General** > Workspace : Other > UTF-8
    - Spring은 JDK 11버전과 호환이 좋음 (이 이상과 호환이 되지 X)
  - myapp* `org.zeorck.controller`



### 01. Maven

- 라이브러리 형상관리. 빌드 도구

  - `pom.xml`에 필요한 라이브러리를 등록하면, maven repository 에서 자동으로 다운로드해서 사용가능
  - 팀 프로젝트시 모든 개발자가 같은 pom.xml을 공유 > 모든 라이브러리버전 통일

- pom.xml

  ```xml
  <properties>
  		<java-version>1.8</java-version>
  		<org.springframework-version>5.0.7.RELEASE</org.springframework-version>
    ...
  <groupId>org.apache.maven.plugins</groupId>
                  <artifactId>maven-compiler-plugin</artifactId>
                  <version>2.5.1</version>
                  <configuration>
                      <source>1.8</source>
                      <target>1.8</target>
                    ...
  ```

  으로 변경하면 `Maven Dependencies` 에 자동 수정이 됨

  - 프로젝트 우클릭 > Maven > Update Project (동기화 중요`ctrl + F5`)
  - 프로젝트 우클릭 > Properties
    - Java Compiler > Use compliance...체크 해제 > Compiler compliance level > 11
    - Java Buil Path > Library > JRE System Library > Edit > Installed JREs
    - Project Facets > Java 버전 11

- 톰캣 서버를 이클립스와 동일하게 맞춘 후, 실행 (자동으로 home.jsp/HomeController.java가 생성되어 있음)



### 02. Lombok

- private으로 설정된 변수를 컴파일시, getter/setter 자동생성해주는 라이브러리

  [다운로드 페이지](https://projectlombok.org/all-versions)

  - Specify location을 클릭해서, sts가 저장된 폴더를 browse후 install
  - Spring 재부팅 후, Help 탭에서 `About Spring Tool Suite 3` 에서 설치되었는지 확인

- 설치후 **pom.xml**에 라이브러리 추가[Lombok_1.18.0](https://mvnrepository.com/artifact/org.projectlombok/lombok/1.18.0)

  ```xml
  <!-- https://mvnrepository.com/artifact/org.projectlombok/lombok -->
  <dependency>
      <groupId>org.projectlombok</groupId>
      <artifactId>lombok</artifactId>
      <version>1.18.0</version>
      <scope>provided</scope>
  </dependency>
  ```

  ​

### 03. Spring의 특성과 의존성 주입

- 의존성 주입(Dependency Injection)
  - 코드의 내부에서 객체간의 연결을 이루지 않고, 외부에서 설정을 통해서 객체간을 연결하는 패턴
  - 컴파일시가 아닌 실행시에 의존 관계가 완성되는 방식
  - 스프링의 경우 의존성 주입을 쉽게 적용할 수 있는 프레임워크
  - 즉, 개발자가 직접 코딩하지 않음



### 04. AOP 지원

- Aspect- Oriented Programming 지원
- 시스템 전반에 필요한 기능들을 모듈화
  - 비즈니스 로직을 가지는 객체와 결합하는 방식
- AOP 방식으로 개발하면 공통모듈을 기존 코드에 적용/삭제가 편리
  - 기존 코드의 변경이 거의 X
- **Cross-concern** : 횡단 관심사
  - 보안이나 로깅과 같이 시스템 여러 곳에서 필요한 공통적 기능
- AOP는 횡단 관심사(Cross-concern)를 분리, 이를 결합하는 기능이 필요한데 스프링은 이러한 기능을 프레임워크에서 지원



### 05. Oracle DB 연동

- Data Resource작업 
  - DB와 Connection을 맺고 끊는 작업은 리소스의 소모가 ㅁ낳은 작업
  - Pooling이라는 기법을 통해 객체를 미리 생성하고 빌려쓰는 방식으로 이용해서 연결시간을 단축
  - Comments DBCP나 HikariCP등을 활용


- pom.xml 에 추가 ([HikariCP_2.7.4](https://mvnrepository.com/artifact/com.zaxxer/HikariCP/2.7.4))

```xml
<!-- https://mvnrepository.com/artifact/com.zaxxer/HikariCP -->
<dependency>
    <groupId>com.zaxxer</groupId>
    <artifactId>HikariCP</artifactId>
    <version>2.7.4</version>
</dependency>
```

- `C:\Users\사용자\.m2\repository` 에 라이브러리 저장이 됨
  - .m2파일을 지우고 새로 sts를 실행하면 초기화 작업이 이루어짐



**context**

- 사전적으로는 문맥이라는 뜻
- programming이나 server관련해서 context는 어떤 관련된 정보를 갖고있는 객체, 서비스 등을 의미

**root_context.xml**

- Spring(Tomcat)이 구동 되면서 root 디렉토리부터 적용될 내용

- `src/main/webapp/WEB_INF/spring/root-context.xml`

  ```xml
  ...
  	<!-- Root Context: defines shared resources visible to all other web components -->
  	<bean id="hikariConfig" class="com.zaxxer.hikari.HikariConfig">
  		<property name="driverClassName" value="oracle.jdbc.driver.OracleDriver"></property> 
  			<property name="jdbcUrl" value="jdbc:oracle:thin:@localhost:1521:XE"></property>

  		<!-- <property name="driverClassName"
  			value="net.sf.log4jdbc.sql.jdbcapi.DriverSpy"></property>
  		<property name="jdbcUrl"
  			value="jdbc:log4jdbc:oracle:thin:@localhost:1521:XE"></property>-->
  			
  		<property name="username" value="haein"></property>
  		<property name="password" value="shinystar"></property>
  	</bean>

  	<!-- HikariCP configuration -->
  	<bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource"
  		destroy-method="close">
  		<constructor-arg ref="hikariConfig" />
  	</bean>

  	<bean id="sqlSessionFactory"
  		class="org.mybatis.spring.SqlSessionFactoryBean">
  		<property name="dataSource" ref="dataSource"></property>
  	</bean>

  	<mybatis-spring:scan base-package="org.zerock.mapper" />
  ...
  </beans>
  ```

  - 추가(지역적으로 선언됨)
  - 전역적으로 설정하기 위해서는 Server의 context.xml에서 선언하면 됨
  - `xmlns` xml name space라는 뜻, `root-context.xml`의 Namespaces 탭에서 확인 가능
    - c#에서도 name space 사용
    - name space는 java의 package와 유사한 역할

- **Spring의 context**

  - `root-context` > `hikariConfig` + `dataSource` + `sqlSessionFactory`

  - 적용이 잘 되지 않을 경우, 프로젝트 우클릭 > Maven > update project

  - Namespace에서 항목 체크

  - 없으면 수동으로 추가

    ```xml
    <beans xmlns="http://www.springframework.org/schema/beans"
    	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    	xmlns:mybatis-spring="http://mybatis.org/schema/mybatis-spring"
    	xmlns:context="http://www.springframework.org/schema/context"
    	xsi:schemaLocation="
        http://www.springframework.org/schema/beans https://www.springframework.org/schema/beans/spring-beans.xsd
        http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-4.3.xsd
        http://mybatis.org/schema/mybatis-spring http://mybatis.org/schema/mybatis-spring-1.2.xsd">
    ```

    - 패키지는 `servlet-context.xml` 에 자동 저장이 되므로 읽히는 것



### 06. MyBatis

- 개발자가 지정한 SQL, 저장프로시저 그리고 몇가지 고급 매핑을 지원하는 지속적인(persistent) 프레임워크

- Java기반의 데이터베이스 연동을 쉽게 해줌

  -  SQL문을 편하게 쓰고, 자바 객체랑 자동으로 매핑

- [MyBatis_3.4.6](https://mvnrepository.com/artifact/org.mybatis/mybatis/3.4.6)

- [MyBatis-Spring_1.3.2](https://mvnrepository.com/artifact/org.mybatis/mybatis-spring/1.3.2)

- MyBatis에서는 DAO 대신 `Mapper` 라고 사용 (CRUD)

  - pom.xml

  ```xml
  <!-- https://mvnrepository.com/artifact/org.mybatis/mybatis -->
  		<dependency>
  		    <groupId>org.mybatis</groupId>
  		    <artifactId>mybatis</artifactId>
  		    <version>3.4.6</version>
  		</dependency>
  		
  		<!-- https://mvnrepository.com/artifact/org.mybatis/mybatis-spring -->
  		<dependency>
  		    <groupId>org.mybatis</groupId>
  		    <artifactId>mybatis-spring</artifactId>
  		    <version>2.0.7</version>
  		</dependency>
  ```

  ​

**시작하기**

**시작하기**

- `src/main/java`의 패키지명대로 `src/main/resource` 에 폴더경로를 설정 후

  - org.zerock.mapper/TimeMapper.java

    ```java
    package org.zerok.mapper;

    import org.apache.ibatis.annotations.Select;

    public interface TimeMapper {
    	@Select("select sysdate from dual")
    	public String getTime();
    	
    	public String getTime2();
    }
    ```

  - org/zerock/mapper/TimeMapper.xml

    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
    <mapper namespace="org.zerock.mapper.TimeMapper">
    	<select id="getTime2" resultType="String">
    		<!-- 세미콜론(;)은 붙이면 X -->
    		select sysdate from dual
    	</select>
    </mapper>
    ```

  - `src/test/java` org.zerock.mapper

    ```java
    package org.zeorck.mapper;

    import org.junit.Test;
    import org.junit.runner.RunWith;
    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.test.context.ContextConfiguration;
    import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
    import org.zerock.mapper.TimeMapper;

    import lombok.Setter;
    import lombok.extern.log4j.Log4j;

    @RunWith(SpringJUnit4ClassRunner.class)
    @ContextConfiguration("file:src/main/webapp/WEB-INF/spring/root-context.xml")

    @Log4j /* Lombok library */
    public class TimeMapperTests {
    	// 주입(injection)
    	@Setter(onMethod_ = @Autowired)
    	private TimeMapper timeMapper;
    	
    	@Test
    	public void testGetTime() {
    		/* 인스턴스 생성없이 바로 호출 가능 */
    		log.info(timeMapper.getTime());
    	}
    }
    ```

    - Run > JUnit Test (단위 테스트) 실행

    - 오류가 날 경우, 아래를 pom.xml에 추가 ([ojdbc](https://mvnrepository.com/artifact/com.oracle.database.jdbc/ojdbc11/23.7.0.25.01), [Spring JDBC](https://mvnrepository.com/artifact/org.springframework/spring-jdbc/6.2.5))

      ```xml
      		<dependency>
      		    <groupId>org.springframework</groupId>
      		    <artifactId>spring-jdbc</artifactId>
      		    <version>${org.springframework-version}</version>
      		</dependency>
              <!-- https://mvnrepository.com/artifact/com.oracle.database.jdbc/ojdbc11 -->
      		<dependency>
      		    <groupId>com.oracle.database.jdbc</groupId>
      		    <artifactId>ojdbc11</artifactId>
      		    <version>21.1.0.0</version>
      		</dependency>

      		<!-- Test -->
      		<dependency>
      			<groupId>junit</groupId>
      			<artifactId>junit</artifactId>
      			<version>4.12</version>
      			<scope>test</scope>
      		</dependency>        
      		<dependency>
      			<groupId>org.springframework</groupId>
      			<artifactId>spring-test</artifactId>
      			<version>${org.springframework-version}</version>
      		</dependency>

      ...
              <!-- https://mvnrepository.com/artifact/org.bgee.log4jdbc-log4j2/log4jdbc-log4j2-jdbc4 -->
              <dependency>
                  <groupId>org.bgee.log4jdbc-log4j2</groupId>
                  <artifactId>log4jdbc-log4j2-jdbc4</artifactId>
                  <version>1.16</version>
              </dependency>

      		<!-- 자세히 로그를 보기 위함 -->
      		<dependency>
      		    <groupId>org.apache.logging.log4j</groupId>
      		    <artifactId>log4j-api</artifactId>
      		    <version>2.17.1</version>
      		</dependency>
      		<dependency>
      		    <groupId>org.apache.logging.log4j</groupId>
      		    <artifactId>log4j-core</artifactId>
      		    <version>2.17.1</version>
      		</dependency>
      ```

      - root-context.xml

      ```xml
      <bean id="hikariConfig" class="com.zaxxer.hikari.HikariConfig">
      		<!-- <property name="driverClassName" value="oracle.jdbc.driver.OracleDriver"></property> 
      			<property name="jdbcUrl" value="jdbc:oracle:thin:@localhost:1521:XE"></property> -->

        		<!-- 자세히 로그를 보기 위함 -->
      		<property name="driverClassName"
      			value="net.sf.log4jdbc.sql.jdbcapi.DriverSpy"></property>
      		<property name="jdbcUrl"
      			value="jdbc:log4jdbc:oracle:thin:@localhost:1521:XE"></property>
      			
      		<property name="username" value="haein"></property>
      		<property name="password" value="shinystar"></property>
      	</bean>
      ```

      - 주석을 바꿈
      - 그럼 `log4jdbc.log4j2` 파일(첨부파일)을 `src/main/resources`에 넣어줘야 함

- pom.xml

  ```XML
  <!-- Servlet -->
  <dependency>
    <groupId>javax.servlet</groupId>
    <artifactId>servlet-api</artifactId>
    <version>2.5</version>
    <scope>provided</scope>
  </dependency>
  ```

  - 이부분을

    ```XML
    <!-- Servlet -->
    <dependency>
      <groupId>javax.servlet</groupId>
      <artifactId>javax.servlet-api</artifactId>
      <version>3.1.0</version>
      <scope>provided</scope>
    </dependency>
    ```

    으로 바꿈



### 07. MVC

- 서블렛 기반이긴 하지만 한 단계 더 추상화된 수준의 개발지향
- 서블릿 API없이도 개발이 가능한 수준

#### 1. Controller

- HttpServletRequest, HttpServletResponse는 Spring에서 자동처리
- `@Controller` 로 사용 `@RequestMapping` 가상의 주소



1. SampleController.java (class)

   ```java
   package org.zerock.controller;

   import org.springframework.stereotype.Controller;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.RequestMapping;
   import org.springframework.web.bind.annotation.RequestMethod;
   import org.zerock.dto.SampleDTO;

   import lombok.extern.log4j.Log4j2;

   @Controller
   @RequestMapping("/sample/*") /* 선행 주소, 이 주소를 사용하기 위해서 views폴더에서 sample이라는 폴더를 생성해야 함 */
   @Log4j2
   public class SampleController {
   	// return 값이 void면 주소와 같은 이름의 jsp로 이동
   	/* basicGet.jsp를 views/sample/에 생성해야함 */
   	@RequestMapping(value="/basicGet",method= {RequestMethod.GET,RequestMethod.POST})
   	public void basicGet() {log.info("basic get...");}
   	
   	// get방식처리
   	@GetMapping("/basicOnlyGet")
   	public void basicGet2() {}
   	
   	@GetMapping("/ex01")
   	public String ex01(SampleDTO dto) {
   		System.out.println(dto);
   		return "/sample/ex01";
   	}
   }
   ```

2. webapp/WEB-INF/views/sample/**basicGet.jsp**

   ```java
   <%@ page language="java" contentType="text/html; charset=UTF-8"
       pageEncoding="UTF-8"%>
   <!DOCTYPE html>
   <html>
   <head>
   <meta charset="UTF-8">
   <title>Insert title here</title>
   </head>
   <body>
   	<h1>basicGet</h1>
   </body>
   </html>
   ```

   webapp/WEB-INF/views/sample/**basicOnlyGet.jsp**

   ```java
   <%@ page language="java" contentType="text/html; charset=UTF-8"
       pageEncoding="UTF-8"%>
   <!DOCTYPE html>
   <html>
   <head>
   <meta charset="UTF-8">
   <title>Insert title here</title>
   </head>
   <body>
   	<h1>basic only get</h1>
   </body>
   </html>
   ```

   webapp/WEB-INF/views/sample/**ex01.jsp**

   ```java
   <%@ page language="java" contentType="text/html; charset=UTF-8"
       pageEncoding="UTF-8"%>
   <!DOCTYPE html>
   <html>
   <head>
   <meta charset="UTF-8">
   <title>Insert title here</title>
   </head>
   <body>
   	<h1>ex01</h1>
   </body>
   </html>
   ```

3. org.zerock.dto/**SampleDTO.java**

   ```java
   package org.zerock.dto;

   import lombok.Data;

   // lombok이 getter, setter 자동 생성
   @Data
   public class SampleDTO {
   	private String name;
   	private int age;
   }
   ```

4. home.jsp

   ```java
   <%@ page language="java" contentType="text/html; charset=UTF-8"
       pageEncoding="UTF-8"%>
   <%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
   <%@ page session="false" %>
   <html>
   <head>
   	<title>Home</title>
   </head>
   <body>
   	<a href="/sample/basicGet">basicGet</a>
   	<a href="/sample/basicOnlyGet">basicGetOnly</a>
   	<a href="/sample/ex01?name=홍길동&age=25">ex01</a>
   </body>
   </html>
   ```





